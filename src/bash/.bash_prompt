#! /usr/bin/env bash

color_reset="\[\e[0m\]"
color_blue="\[\e[34m\]"
color_green="\[\e[32m\]"
color_grey="\[\e[90m\]"
color_yellow="\[\e[1;33m\]"
color_ltblue="\[\e[36m\]"

git_prompt_prefix="${color_yellow}git${color_green}"

git_prompt() {
  workdir="$(pwd)"
  
  # check if in git repo
  if git rev-parse 2>/dev/null; then
    # in git
    gitroot="$(git rev-parse --show-toplevel)"
    gitbase="$(basename "$gitroot")"
    # detect if in a symlink
    if [[ $workdir != $gitroot*  ]]; then
      printf "%s %s %s"  "$git_prompt_prefix" "${workdir/$HOME/~}" "$color_ltblue[-> ${gitroot/$HOME/~}]$color_reset"
    else
      printf "%s %s"  "$git_prompt_prefix" "$gitbase${workdir/$gitroot/}"
    fi
  else 
    # not in git
    printf "%s" "${workdir/$HOME/~}"
  fi
}

set_bash_prompt() {
  new_line=""
  COLS=$(tput cols)
  NOCOLOR_PROMPT_STRING="\u@\h:$(git_prompt) \$"
  
  if [[ $COLS -lt ${#NOCOLOR_PROMPT_STRING} ]]; then
    new_line="\n"
  fi

  PS1="$color_blue\u$color_ltblue@$color_blue\h:$color_green$(git_prompt)$color_grey $new_line\$ $color_reset"
}

NOCOLOR_PROMPT_STRING=COLOR_PROMPT_STRING=

PROMPT_COMMAND='set_bash_prompt'
